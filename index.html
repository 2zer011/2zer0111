<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Äiá»ƒm danh v6.0 - Báº¢N KHÃ”NG Máº¤T Dá»® LIá»†U</title>
  <style>
    :root {
      --bg: #0b0f1a;
      --card-bg: #161c2d;
      --primary: #38bdf8;
      --danger: #ef4444;
      --success: #22c55e;
      --text: #f1f5f9;
      --radius: 12px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 10px;
    }

    .container {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
      text-align: center;
      max-width: 480px;
      width: 100%;
    }

    h1 {
      color: var(--primary);
      margin: 0;
      font-size: 1.8rem;
      letter-spacing: -1px;
    }

    .ver {
      font-size: 0.75rem;
      color: #fde047;
      font-weight: bold;
      margin-bottom: 20px;
      display: block;
    }

    .countdown {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #fde047;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .input-group {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 1rem;
    }

    input {
      padding: 1rem;
      border-radius: 10px;
      border: 2px solid #334155;
      background: #0f172a;
      color: #fff;
      width: 100%;
      outline: none;
      transition: 0.2s;
    }

    input:focus {
      border-color: var(--primary);
    }

    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.8rem 1.2rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
    }

    .btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .status-card {
      margin: 15px 0;
      font-size: 0.95rem;
      padding: 12px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid #334155;
    }

    .leaderboard {
      margin-top: 25px;
      text-align: left;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    td {
      padding: 12px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    tr.me {
      background: rgba(56, 189, 248, 0.15);
      border-left: 4px solid var(--primary);
    }

    .sync-indicator {
      font-size: 0.7rem;
      margin-top: 20px;
      padding: 8px;
      border-radius: 5px;
      background: #000;
      border: 1px solid #334155;
      display: inline-block;
    }

    .diag-box {
      margin-top: 20px;
      font-size: 0.65rem;
      color: #64748b;
      text-align: left;
      height: 100px;
      overflow-y: auto;
      font-family: monospace;
      border: 1px dashed #334155;
      padding: 8px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ“… Äiá»ƒm danh v6.0</h1>
    <span class="ver">ğŸ’ Báº¢N CHá»NG Máº¤T Dá»® LIá»†U TUYá»†T Äá»I ğŸ’</span>

    <div id="countdown" class="countdown">â³ ...</div>

    <div class="input-group">
      <input type="text" id="nameField" placeholder="Nháº­p tÃªn cá»§a báº¡n..." />
      <button id="saveBtn" class="btn">LÆ°u tÃªn</button>
    </div>

    <div class="status-card" id="status">Vui lÃ²ng chá» Ä‘á»“ng bá»™...</div>
    <button id="checkinBtn" class="btn" style="width: 100%; height: 50px; font-size: 1.1rem;" disabled>ğŸŸ¢ ÄIá»‚M DANH
      NGAY</button>

    <div class="leaderboard">
      <h3 style="margin:0 0 10px 0; color:var(--primary);">ğŸ† Báº£ng xáº¿p háº¡ng</h3>
      <table>
        <tbody id="leaderBody"></tbody>
      </table>
    </div>

    <div id="syncMsg" class="sync-indicator">ï¿½ Tráº¡ng thÃ¡i: Äang káº¿t ná»‘i...</div>

    <div id="diag" class="diag-box"></div>

    <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center;">
      <button onclick="location.reload(true)"
        style="padding: 5px 10px; font-size: 0.7rem; background:#334155; color:white; border:none; border-radius:5px; cursor:pointer;">ğŸ”„
        Load láº¡i</button>
      <button onclick="if(confirm('XÃ³a sáº¡ch?')){localStorage.clear(); location.reload(true)}"
        style="padding: 5px 10px; font-size: 0.7rem; background:#ef4444; color:white; border:none; border-radius:5px; cursor:pointer;">ï¿½ï¸
        Reset tÃªn</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const diag = document.getElementById('diag');
    function log(m, type = "info") {
      const color = type === "err" ? "#ef4444" : type === "ok" ? "#22c55e" : "#64748b";
      diag.innerHTML += `<div style="color:${color}">> ${m}</div>`;
      diag.scrollTop = diag.scrollHeight;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDhgpbLOVXdQ5Q6UvkYYMPi66RFdZ4ogLc",
      authDomain: "dielife-d5a74.firebaseapp.com",
      projectId: "dielife-d5a74",
      storageBucket: "dielife-d5a74.firebasestorage.app",
      messagingSenderId: "654557385964",
      appId: "1:654557385964:web:22f4debf14df0ae26e81c9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 1. Ã‰P KIá»‚U Káº¾T Ná»I (LONG POLLING)
    db.settings({ experimentalForceLongPolling: true, useFetchStreams: false });

    // 2. KÃCH HOáº T LÆ¯U TRá»® TRÃŠN á»” Cá»¨NG (DISK PERSISTENCE)
    // Sáº½ lÆ°u láº¡i dá»¯ liá»‡u ngay cáº£ khi F5 hoáº·c táº¯t máº¡ng
    firebase.firestore().enablePersistence({ synchronizeTabs: true })
      .then(() => log("âœ… ÄÃ£ báº­t cháº¿ Ä‘á»™ lÆ°u trá»¯ á»• cá»©ng (Persistence)", "ok"))
      .catch((err) => log("âš ï¸ KhÃ´ng thá»ƒ lÆ°u á»• cá»©ng: " + err.code));

    let myName = localStorage.getItem('attendanceUsername') || '';
    let hasCheckin = false;
    const today = () => new Date().toISOString().split('T')[0];

    const nameField = document.getElementById('nameField');
    const statusEl = document.getElementById('status');
    const checkinBtn = document.getElementById('checkinBtn');
    const syncMsg = document.getElementById('syncMsg');

    if (myName) nameField.value = myName;

    // Láº®NG NGHE REAL-TIME
    db.collection('users').onSnapshot(snap => {
      log("ğŸ“¥ Dá»¯ liá»‡u tá»« mÃ¢y Ä‘Ã£ Ä‘á»“ng bá»™!", "ok");
      syncMsg.innerHTML = "ğŸ“¡ Tráº¡ng thÃ¡i: <span style='color:#22c55e'>ÄÃ£ káº¿t ná»‘i mÃ¢y</span>";

      const list = [];
      snap.forEach(d => {
        const data = d.data();
        list.push({ n: d.id, c: (data.checkins || []).length });
        if (d.id === myName) {
          hasCheckin = (data.checkins || []).includes(today());
        }
      });
      list.sort((a, b) => b.c - a.c);
      document.getElementById('leaderBody').innerHTML = list.map((u, i) => `
        <tr class="${u.n === myName ? 'me' : ''}"><td>${i + 1}</td><td>${u.n}</td><td>${u.c} ngÃ y</td></tr>
      `).join('');
      updateUI();
    }, err => {
      log("âŒ Lá»—i káº¿t ná»‘i: " + err.message, "err");
      syncMsg.innerHTML = "ğŸ“¡ Tráº¡ng thÃ¡i: <span style='color:#fde047'>Äang cháº¡y ngoáº¡i tuyáº¿n (Offline)</span>";
      updateUI();
    });

    function updateUI() {
      if (!myName) {
        statusEl.textContent = "ğŸ‘‹ ChÃ o má»«ng! HÃ£y nháº­p tÃªn cá»§a báº¡n.";
        checkinBtn.disabled = true;
      } else if (hasCheckin) {
        statusEl.innerHTML = "<span style='color:var(--success); font-weight:bold;'>âœ… Báº N ÄÃƒ ÄIá»‚M DANH HÃ”M NAY!</span>";
        checkinBtn.disabled = true;
        checkinBtn.textContent = "Háº¸N Gáº¶P Láº I VÃ€O MAI";
      } else {
        statusEl.innerHTML = "ğŸ”” Sáºµn sÃ ng Ä‘iá»ƒm danh cho <b>" + myName + "</b>";
        checkinBtn.disabled = false;
        checkinBtn.textContent = "ğŸŸ¢ ÄIá»‚M DANH NGAY";
      }
    }

    document.getElementById('saveBtn').onclick = () => {
      const n = nameField.value.trim();
      if (!n) return;
      localStorage.setItem('attendanceUsername', n);
      myName = n;
      log("ğŸ’¾ ÄÃ£ lÆ°u tÃªn: " + n);
      // Ghi Ä‘á»ƒ Ä‘áº£m báº£o User tá»“n táº¡i
      db.collection('users').doc(n).set({}, { merge: true });
      updateUI();
    };

    checkinBtn.onclick = () => {
      if (!myName) return;
      checkinBtn.disabled = true;
      checkinBtn.textContent = "â³ ÄANG Gá»¬I...";

      // Gá»¬I Tá»I THÆ¯á»¢NG: set + arrayUnion + merge
      // CÃ¡ch nÃ y vá»«a táº¡o má»›i náº¿u chÆ°a cÃ³, vá»«a thÃªm ngÃ y mÃ  khÃ´ng lÃ m máº¥t ngÃ y cÅ©
      db.collection('users').doc(myName).set({
        checkins: firebase.firestore.FieldValue.arrayUnion(today())
      }, { merge: true }).then(() => {
        log("âœ… Ghi thÃ nh cÃ´ng lÃªn Cloud!", "ok");
      }).catch(e => {
        log("â³ ÄÃ£ lÆ°u vÃ o mÃ¡y, sáº½ gá»­i Cloud khi cÃ³ máº¡ng.", "ok");
      });

      // Optimistic UI: Hiá»‡u á»©ng Ä‘iá»ƒm danh thÃ nh cÃ´ng ngay láº­p tá»©c
      hasCheckin = true;
      updateUI();
    };

    setInterval(() => {
      const diff = new Date().setHours(24, 0, 0, 0) - new Date();
      if (diff < 0) return location.reload();
      const h = Math.floor(diff / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
      document.getElementById('countdown').textContent = `â³ Háº¿t háº¡n: ${h}h ${m}m ${s}s`;
    }, 1000);

    updateUI();
  </script>
</body>

</html>