<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒêi·ªÉm danh v5.1 - KI·ªÇM TRA S√ÇU</title>
  <style>
    :root {
      --bg: #0b0f1a;
      --card-bg: #161c2d;
      --primary: #38bdf8;
      --danger: #ef4444;
      --success: #22c55e;
      --text: #f1f5f9;
      --radius: 12px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 10px;
    }

    .container {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
      text-align: center;
      max-width: 480px;
      width: 100%;
    }

    h1 {
      color: var(--primary);
      margin: 0;
      font-size: 1.6rem;
    }

    .ver {
      font-size: 0.7rem;
      color: #fde047;
      font-weight: bold;
      margin-bottom: 20px;
      display: block;
    }

    .status {
      margin: 15px 0;
      font-size: 0.9rem;
      padding: 10px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid #334155;
    }

    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.8rem 1.2rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* BXH */
    .leaderboard {
      margin-top: 20px;
      text-align: left;
      background: #0b1120;
      padding: 10px;
      border-radius: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    td {
      padding: 10px 5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* DIAGNOSTIC HUB */
    .diag-hub {
      margin-top: 25px;
      border: 1px solid #38bdf8;
      border-radius: 10px;
      padding: 10px;
      text-align: left;
      background: #000;
    }

    .diag-title {
      font-size: 0.75rem;
      color: #38bdf8;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .diag-log {
      font-size: 0.65rem;
      color: #94a3b8;
      height: 120px;
      overflow-y: auto;
      font-family: monospace;
    }

    .config-check {
      font-size: 0.6rem;
      color: #4ade80;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #334155;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üìÖ ƒêi·ªÉm danh v5.1</h1>
    <span class="ver">üîç B·∫¢N KI·ªÇM TRA L·ªñI TO√ÄN DI·ªÜN</span>

    <div class="status" id="status">ƒêang t·∫£i c·∫•u h√¨nh k·∫øt n·ªëi...</div>

    <div class="input-group" style="display:flex; gap:5px; margin-bottom:10px;">
      <input type="text" id="nameField" placeholder="Nh·∫≠p t√™n..."
        style="flex:1; padding:10px; background:#0f172a; border:1px solid #334155; color:white; border-radius:8px;" />
      <button id="saveBtn" class="btn">L∆∞u</button>
    </div>

    <button id="checkinBtn" class="btn" style="width: 100%; height: 50px;" disabled>üü¢ ƒêI·ªÇM DANH TH·ª¨</button>

    <div class="leaderboard">
      <h3 style="margin:0 0 10px 0; font-size:1rem; color:var(--primary);">üèÜ B·∫£ng x·∫øp h·∫°ng</h3>
      <table>
        <tbody id="leaderBody"></tbody>
      </table>
    </div>

    <!-- C√îNG C·ª§ CH·∫®N ƒêO√ÅN -->
    <div class="diag-hub">
      <div class="diag-title">ÔøΩÔ∏è TRUNG T√ÇM CH·∫®N ƒêO√ÅN L·ªñI</div>
      <div id="diagLog" class="diag-log"></div>

      <div id="configInfo" class="config-check">
        <b>D·ª± √°n:</b> dielife-d5a74<br>
        <b>API Key:</b> AIzaSy...ogLc
      </div>
    </div>

    <div style="margin-top: 10px; display: flex; gap: 5px; justify-content: center;">
      <button id="testBtn"
        style="font-size: 0.7rem; background:#22c55e; color:black; border:none; padding:8px; border-radius:5px; cursor:pointer; font-weight:bold;">‚ö°
        TEST K·∫æT N·ªêI NGAY</button>
      <button onclick="location.reload(true)"
        style="font-size: 0.7rem; background:#334155; color:white; border:none; padding:8px; border-radius:5px;">ÔøΩ T·∫£i
        l·∫°i trang</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const diagLog = document.getElementById('diagLog');
    function log(m, type = "info") {
      const color = type === "err" ? "#ef4444" : type === "ok" ? "#22c55e" : "#94a3b8";
      diagLog.innerHTML += `<div style="color:${color}">> ${m}</div>`;
      diagLog.scrollTop = diagLog.scrollHeight;
      console.log(m);
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDhgpbLOVXdQ5Q6UvkYYMPi66RFdZ4ogLc",
      authDomain: "dielife-d5a74.firebaseapp.com",
      projectId: "dielife-d5a74",
      storageBucket: "dielife-d5a74.firebasestorage.app",
      messagingSenderId: "654557385964",
      appId: "1:654557385964:web:22f4debf14df0ae26e81c9"
    };

    log("üîå ƒêang kh·ªüi t·∫°o Firebase v5.1...");
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    db.settings({ experimentalForceLongPolling: true, useFetchStreams: false });

    let myName = localStorage.getItem('attendanceUsername') || '';
    if (myName) {
      document.getElementById('nameField').value = myName;
      document.getElementById('status').textContent = "üîî Ch√†o " + myName;
    }

    // BUTTON TEST K·∫æT N·ªêI
    document.getElementById('testBtn').onclick = async () => {
      log("‚ö° B·∫Øt ƒë·∫ßu Test K·∫øt N·ªëi...");
      try {
        const testRef = db.collection('_test_connection').doc('status');
        await testRef.set({ time: new Date().toISOString() });
        log("‚úÖ K·∫æT N·ªêI TH√ÄNH C√îNG! Database ƒëang ho·∫°t ƒë·ªông.", "ok");
      } catch (e) {
        log("‚ùå L·ªñI K·∫æT N·ªêI: " + e.message, "err");
        if (e.message.includes("does not exist")) {
          log("üëâ Gi·∫£i ph√°p: B·∫°n h√£y v√†o Firebase Console, m·ª•c Firestore Database, nh·∫•n n√∫t 'T·∫°o Database' (Create Database) v√† ch·ªçn 'Native Mode'.", "err");
        } else if (e.message.includes("permission-denied")) {
          log("üëâ Gi·∫£i ph√°p: B·∫°n h√£y v√†o tab 'Rules' (S·ª≠a l·ªói b·∫£o m·∫≠t) trong Firebase v√† ch·ªânh th√†nh 'allow read, write: if true;'.", "err");
        }
      }
    };

    // L·∫ÆNG NGHE BXH
    db.collection('users').limit(20).onSnapshot(snap => {
      log("üì• ƒê√£ t·∫£i d·ªØ li·ªáu BXH.", "ok");
      const list = [];
      snap.forEach(d => list.push({ n: d.id, c: (d.data().checkins || []).length }));
      list.sort((a, b) => b.c - a.c);
      document.getElementById('leaderBody').innerHTML = list.map((u, i) => `
        <tr><td>${i + 1}</td><td>${u.n}</td><td>${u.c} ng√†y</td></tr>
      `).join('');
      document.getElementById('checkinBtn').disabled = !myName;
    }, err => {
      log("‚ùå L·ªói Real-time: " + err.message, "err");
    });

    document.getElementById('saveBtn').onclick = () => {
      const n = document.getElementById('nameField').value.trim();
      if (!n) return;
      localStorage.setItem('attendanceUsername', n);
      myName = n;
      log("üíæ ƒê√£ l∆∞u t√™n: " + n);
      db.collection('users').doc(n).set({}, { merge: true });
      document.getElementById('checkinBtn').disabled = false;
      document.getElementById('status').textContent = "üîî Ch√†o " + n;
    };

    document.getElementById('checkinBtn').onclick = async () => {
      if (!myName) return;
      log("‚è≥ ƒêang g·ª≠i ƒëi·ªÉm danh...");
      const t = new Date().toISOString().split('T')[0];
      try {
        await db.collection('users').doc(myName).set({
          checkins: firebase.firestore.FieldValue.arrayUnion(t)
        }, { merge: true });
        log("‚úÖ ƒê√£ ƒëi·ªÉm danh th√†nh c√¥ng!", "ok");
      } catch (e) {
        log("‚ùå L·ªói ƒëi·ªÉm danh: " + e.message, "err");
      }
    };

    log("üèÅ ƒê√£ s·∫µn s√†ng. B·∫°n h√£y nh·∫•n n√∫t 'TEST K·∫æT N·ªêI' m√†u xanh ƒë·ªÉ ki·ªÉm tra.");
  </script>
</body>

</html>