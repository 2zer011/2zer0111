<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Äiá»ƒm danh v8.0 - Äá»’NG Bá»˜ TUYá»†T Äá»I</title>
  <style>
    :root {
      --bg: #0b0f1a;
      --card-bg: #161c2d;
      --primary: #38bdf8;
      --danger: #ef4444;
      --success: #22c55e;
      --text: #f1f5f9;
      --radius: 12px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 10px;
    }

    .container {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      text-align: center;
      max-width: 480px;
      width: 100%;
    }

    h1 {
      color: var(--primary);
      margin: 0;
      font-size: 1.8rem;
      letter-spacing: -1px;
    }

    .ver {
      font-size: 0.75rem;
      color: #fde047;
      font-weight: bold;
      margin-bottom: 20px;
      display: block;
    }

    .status-card {
      margin: 15px 0;
      padding: 15px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid #334155;
    }

    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 1rem 1.5rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }

    .btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .leaderboard {
      margin-top: 25px;
      text-align: left;
      background: #0b1120;
      padding: 10px;
      border-radius: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    td {
      padding: 10px 5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sync-monitor {
      margin-top: 25px;
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 12px;
      text-align: left;
      background: #000;
    }

    .sync-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .sync-status {
      font-size: 0.75rem;
      font-weight: bold;
    }

    .diag-log {
      font-size: 0.65rem;
      color: #94a3b8;
      height: 100px;
      overflow-y: auto;
      font-family: monospace;
      border-top: 1px solid #334155;
      padding-top: 8px;
    }

    .chat-box {
      background: #000;
      border: 1px solid #334155;
      height: 150px;
      overflow-y: auto;
      margin: 10px 0;
      padding: 10px;
      text-align: left;
      border-radius: 8px;
    }

    .msg {
      margin-bottom: 5px;
      font-size: 0.8rem;
    }

    .msg-u {
      color: var(--primary);
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ“… Äiá»ƒm danh v8.0</h1>
    <span class="ver">ğŸ’ Báº¢N Äá»’NG Bá»˜ ÄA THIáº¾T Bá»Š ğŸ’</span>

    <div class="status-card" id="status">Vui lÃ²ng nháº­p tÃªn...</div>

    <div class="input-group" style="display:flex; gap:5px; margin-bottom:15px;">
      <input type="text" id="nameField" placeholder="Nháº­p tÃªn..."
        style="flex:1; padding:12px; background:#0f172a; border:1px solid #334155; color:white; border-radius:10px;" />
      <button id="saveBtn" class="btn">LÆ°u</button>
    </div>

    <button id="checkinBtn" class="btn" style="width: 100%; height: 50px;" disabled>ğŸŸ¢ ÄIá»‚M DANH NGAY</button>

    <div class="leaderboard">
      <h3 style="margin:0 0 10px 0; color:var(--primary); font-size:0.9rem;">ğŸ† BXH (Nhá»¯ng ai Ä‘Ã£ lÃªn Cloud)</h3>
      <table>
        <tbody id="leaderBody"></tbody>
      </table>
    </div>

    <!-- KHUNG CHAT Äá»‚ TEST -->
    <div id="chatSection" style="display:none; margin-top:20px;">
      <div style="font-size:0.8rem; font-weight:bold; color:var(--primary);">ğŸ’¬ Chat NhÃ³m (Äá»ƒ kiá»ƒm tra Ä‘á»“ng bá»™)</div>
      <div id="chatBox" class="chat-box"></div>
      <div style="display:flex; gap:5px;">
        <input type="text" id="chatInput" placeholder="Nháº¯n gÃ¬ Ä‘Ã³..."
          style="flex:1; padding:8px; background:#0f172a; border:1px solid #334155; color:white; border-radius:8px;" />
        <button id="sendBtn" class="btn" style="padding:0 15px;">Gá»­i</button>
      </div>
    </div>

    <!-- KHUNG GIÃM SÃT Äá»’NG Bá»˜ -->
    <div class="sync-monitor">
      <div class="sync-bar">
        <span class="sync-status" id="syncLabel">â³ Äang kiá»ƒm tra mÃ¢y...</span>
        <div id="syncDot" style="width:12px; height:12px; border-radius:50%; background:#64748b;"></div>
      </div>
      <div id="pendingStatus" style="font-size:0.7rem; color:#fde047; margin-bottom:5px;">ğŸ” Äang theo dÃµi tiáº¿n trÃ¬nh
        gá»­i dá»¯ liá»‡u...</div>
      <div id="diag" class="diag-log"></div>
    </div>

    <div style="margin-top: 15px; display: flex; gap: 5px; justify-content: center;">
      <button id="uploadTest"
        style="font-size:0.7rem; background:#22c55e; color:black; border:none; padding:8px; border-radius:5px; font-weight:bold; cursor:pointer;">ï¿½
        THá»¬ Äáº¨Y LÃŠN MÃ‚Y</button>
      <button onclick="location.reload(true)"
        style="font-size: 0.7rem; background:#334155; color:white; border:none; padding:8px; border-radius:5px;">ï¿½
        Refresh</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const diag = document.getElementById('diag');
    function log(m, type = "info") {
      const color = type === "err" ? "#ef4444" : type === "ok" ? "#22c55e" : "#94a3b8";
      diag.innerHTML += `<div style="color:${color}">> ${m}</div>`;
      diag.scrollTop = diag.scrollHeight;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDhgpbLOVXdQ5Q6UvkYYMPi66RFdZ4ogLc",
      authDomain: "dielife-d5a74.firebaseapp.com",
      projectId: "dielife-d5a74",
      storageBucket: "dielife-d5a74.firebasestorage.app",
      messagingSenderId: "654557385964",
      appId: "1:654557385964:web:22f4debf14df0ae26e81c9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    db.settings({ experimentalForceLongPolling: true, useFetchStreams: false });

    // Cá» Gáº®NG Báº¬T CACHE (Náº¿u lá»—i váº«n cho cháº¡y tiáº¿p)
    firebase.firestore().enablePersistence({ synchronizeTabs: true }).catch(e => {
      log("âš ï¸ LÆ°u Ã½: Cache á»• cá»©ng bá»‹ giá»›i háº¡n (cÃ³ thá»ƒ do má»Ÿ nhiá»u tab).", "err");
    });

    let myName = localStorage.getItem('attendanceUsername') || '';
    let hasCheckin = false;
    if (myName) document.getElementById('nameField').value = myName;

    // GIÃM SÃT Káº¾T Ná»I
    db.collection('_health').doc('heartbeat').onSnapshot(() => {
      document.getElementById('syncDot').style.background = "#22c55e";
      document.getElementById('syncDot').style.boxShadow = "0 0 10px #22c55e";
      document.getElementById('syncLabel').innerHTML = "<span style='color:#22c55e'>MÃ‚Y ÄÃƒ THÃ”NG SUá»T</span>";
      log("ğŸ“¡ Káº¿t ná»‘i Google: OK", "ok");
    }, err => {
      document.getElementById('syncDot').style.background = "#ef4444";
      document.getElementById('syncLabel').innerHTML = "<span style='color:#ef4444'>Bá»Š CHáº¶N: " + err.code + "</span>";
    });

    // THEO DÃ•I Dá»® LIá»†U ÄANG CHá»œ (CHÆ¯A LÃŠN MÃ‚Y)
    setInterval(async () => {
      try {
        // waitForPendingWrites sáº½ chá» cho Ä‘áº¿n khi dá»¯ liá»‡u Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng
        // á» Ä‘Ã¢y mÃ¬nh dÃ¹ng má»™t máº¹o nhá» Ä‘á»ƒ kiá»ƒm tra xem cÃ³ dá»¯ liá»‡u chá» khÃ´ng qua metadata cá»§a snapshot
      } catch (e) { }
    }, 2000);

    // Láº®NG NGHE BXH
    db.collection('users').onSnapshot(snap => {
      log("ğŸ“¥ ÄÃ£ táº£i BXH má»›i tá»« MÃ¢y.", "ok");
      const list = [];
      const today = new Date().toISOString().split('T')[0];
      snap.forEach(d => {
        const data = d.data();
        list.push({ n: d.id, c: (data.checkins || []).length });
        if (d.id === myName) hasCheckin = (data.checkins || []).includes(today);
      });
      list.sort((a, b) => b.c - a.c);
      document.getElementById('leaderBody').innerHTML = list.map((u, i) => `
        <tr style="${u.n === myName ? 'background:rgba(56,189,248,0.1); border-left:3px solid #38bdf8;' : ''}"><td>${i + 1}</td><td>${u.n}</td><td>${u.c} ngÃ y</td></tr>
      `).join('');
      updateUI();
    });

    // Láº®NG NGHE CHAT
    db.collection('messages').orderBy('time', 'desc').limit(20).onSnapshot(snap => {
      const msgs = [];
      snap.forEach(d => msgs.push(d.data()));
      document.getElementById('chatBox').innerHTML = msgs.map(m => `
        <div class="msg"><span class="msg-u">${m.user}:</span><span> ${m.text}</span></div>
      `).join('');
    });

    // TEST Äáº¨Y Dá»® LIá»†U Cá»°C Máº NH (Await Server Confirmation)
    document.getElementById('uploadTest').onclick = async () => {
      log("ğŸš€ Äang thá»­ gá»­i dá»¯ liá»‡u kiá»ƒm tra...");
      document.getElementById('pendingStatus').innerHTML = "â³ Äang Ä‘áº©y dá»¯ liá»‡u lÃªn Google Cloud...";
      try {
        await db.collection('_sync_test').doc('status').set({
          user: myName || 'guest',
          time: firebase.firestore.FieldValue.serverTimestamp()
        });
        log("âœ… Äáº¨Y Dá»® LIá»†U THÃ€NH CÃ”NG! Server Ä‘Ã£ nháº­n.", "ok");
        document.getElementById('pendingStatus').innerHTML = "âœ… Dá»¯ liá»‡u Ä‘Ã£ lÃªn MÃ¢y thÃ nh cÃ´ng!";
        alert("ThÃ nh cÃ´ng! MÃ¡y báº¡n Ä‘Ã£ gá»­i Ä‘Æ°á»£c dá»¯ liá»‡u lÃªn Google Cloud.");
      } catch (e) {
        log("âŒ KHÃ”NG THá»‚ Gá»¬I: " + e.message, "err");
        document.getElementById('pendingStatus').innerHTML = "âŒ Gá»­i tháº¥t báº¡i: " + e.message;
        if (e.message.includes("permission")) alert("Lá»—i: Báº¡n chÆ°a má»Ÿ quyá»n Write trong Cloud Firestore Rules!");
      }
    };

    function updateUI() {
      const btn = document.getElementById('checkinBtn');
      const st = document.getElementById('status');
      const chat = document.getElementById('chatSection');
      if (!myName) {
        st.textContent = "ğŸ‘‹ Vui lÃ²ng nháº­p tÃªn.";
        btn.disabled = true; chat.style.display = "none";
      } else if (hasCheckin) {
        st.innerHTML = "<span style='color:#22c55e;'>âœ… Báº N ÄÃƒ ÄIá»‚M DANH!</span>";
        btn.disabled = true; btn.textContent = "Háº¸N Gáº¶P Láº I";
        chat.style.display = "block";
      } else {
        st.innerHTML = "ğŸ”” " + myName + " Æ¡i, Ä‘iá»ƒm danh thÃ´i!";
        btn.disabled = false; btn.textContent = "ğŸŸ¢ ÄIá»‚M DANH NGAY";
        chat.style.display = "none";
      }
    }

    document.getElementById('saveBtn').onclick = () => {
      const n = document.getElementById('nameField').value.trim();
      if (!n) return;
      localStorage.setItem('attendanceUsername', n);
      myName = n;
      log("ğŸ’¾ ÄÃ£ lÆ°u tÃªn: " + n);
      db.collection('users').doc(n).set({}, { merge: true });
      updateUI();
    };

    document.getElementById('checkinBtn').onclick = async () => {
      if (!myName) return;
      const t = new Date().toISOString().split('T')[0];
      log("â³ Äang gá»­i Ä‘iá»ƒm danh...");
      try {
        await db.collection('users').doc(myName).set({
          checkins: firebase.firestore.FieldValue.arrayUnion(t)
        }, { merge: true });
        log("âœ… Äiá»ƒm danh ÄÃƒ LÃŠN MÃ‚Y!", "ok");
      } catch (e) {
        log("â³ Äang chá» máº¡ng (Gá»­i cháº­m)...", "ok");
      }
      hasCheckin = true; updateUI();
    };

    function sendChat() {
      const i = document.getElementById('chatInput');
      const text = i.value.trim();
      if (!text || !myName || !hasCheckin) return;
      i.value = "";
      db.collection('messages').add({ user: myName, text, time: firebase.firestore.FieldValue.serverTimestamp() });
    }
    document.getElementById('sendBtn').onclick = sendChat;
    document.getElementById('chatInput').onkeypress = (e) => { if (e.key === 'Enter') sendChat(); };
  </script>
</body>

</html>