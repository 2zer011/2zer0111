<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒêi·ªÉm danh v3.7 - FINAL FIX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --primary: #38bdf8;
      --danger: #f87171;
      --success: #4ade80;
      --text: #e2e8f0;
      --radius: 12px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 15px;
    }

    .container {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      text-align: center;
      max-width: 450px;
      width: 100%;
    }

    h1 {
      color: var(--primary);
      margin: 0.5rem 0;
      font-size: 1.8rem;
      letter-spacing: -1px;
    }

    .ver {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-bottom: 1.5rem;
      display: block;
    }

    .countdown {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      color: #fde047;
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
    }

    input {
      padding: 0.8rem;
      border-radius: 8px;
      border: 2px solid #334155;
      background: #0f172a;
      color: #fff;
      width: 100%;
      outline: none;
      transition: 0.2s;
    }

    input:focus {
      border-color: var(--primary);
    }

    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      border-radius: var(--radius);
      cursor: pointer;
      transition: 0.3s;
      font-weight: bold;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(56, 189, 248, 0.4);
    }

    .btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      margin: 1rem 0;
      font-size: 1.1rem;
      padding: 12px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.2);
    }

    .leaderboard {
      margin-top: 2rem;
      text-align: left;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      opacity: 0.5;
      font-size: 0.8rem;
      text-transform: uppercase;
      padding-bottom: 8px;
    }

    td {
      padding: 12px 8px;
      border-bottom: 1px solid #334155;
    }

    tr.me {
      background: rgba(56, 189, 248, 0.1);
      border-left: 4px solid var(--primary);
    }

    .chat-section {
      margin-top: 2rem;
      border-top: 2px solid #334155;
      padding-top: 1.5rem;
      display: none;
    }

    .chat-box {
      background: #0b1120;
      border-radius: 12px;
      height: 220px;
      overflow-y: auto;
      padding: 15px;
      margin-bottom: 15px;
      text-align: left;
      border: 1px solid #334155;
    }

    .msg {
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .msg-user {
      font-weight: bold;
      color: var(--primary);
    }

    .msg-text {
      color: #f1f5f9;
      margin-left: 6px;
    }

    .btn-reset {
      margin-top: 20px;
      background: none;
      border: none;
      color: var(--danger);
      font-size: 0.75rem;
      cursor: pointer;
      opacity: 0.6;
    }

    .btn-reset:hover {
      opacity: 1;
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üìÖ ƒêi·ªÉm danh v3.7</h1>
    <span class="ver">B·∫£n s·ª≠a l·ªói "M·∫•t t√™n" & "K·∫πt n√∫t"</span>

    <div id="countdown" class="countdown">‚è≥ ƒêang t·∫£i th·ªùi gian...</div>

    <div class="input-group">
      <input type="text" id="nameField" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." />
      <button id="saveBtn" class="btn">L∆∞u t√™n</button>
    </div>

    <div id="status" class="status">Vui l√≤ng nh·∫≠p t√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
    <button id="checkinBtn" class="btn" style="width: 100%; height: 50px;" disabled>üü¢ ƒêI·ªÇM DANH NGAY</button>

    <div class="leaderboard">
      <h3>üèÜ B·∫£ng x·∫øp h·∫°ng</h3>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>T√™n</th>
            <th>S·ªë ng√†y</th>
          </tr>
        </thead>
        <tbody id="leaderBody">
          <tr>
            <td colspan="3" style="text-align:center; opacity:0.5;">ƒêang t·∫£i d·ªØ li·ªáu...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="chatSection" class="chat-section">
      <div style="text-align:left; color: var(--primary); font-weight:bold; margin-bottom:10px;">üí¨ Chat Nh√≥m</div>
      <div id="chatBox" class="chat-box"></div>
      <div class="input-group">
        <input type="text" id="chatInput" placeholder="Nh·∫Øn g√¨ ƒë√≥..." />
        <button id="sendBtn" class="btn">G·ª≠i</button>
      </div>
    </div>

    <button class="btn-reset"
      onclick="if(confirm('X√≥a s·∫°ch d·ªØ li·ªáu v√† b·∫Øt ƒë·∫ßu l·∫°i?')){localStorage.clear(); location.reload();}">üóëÔ∏è X√≥a t√™n &
      Reset ·ª©ng d·ª•ng</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const config = {
      apiKey: "AIzaSyDhgpbLOVXdQ5Q6UvkYYMPi66RFdZ4ogLc",
      authDomain: "dielife-d5a74.firebaseapp.com",
      projectId: "dielife-d5a74",
      storageBucket: "dielife-d5a74.firebasestorage.app",
      messagingSenderId: "654557385964",
      appId: "1:654557385964:web:22f4debf14df0ae26e81c9"
    };
    firebase.initializeApp(config);
    const db = firebase.firestore();
    db.settings({ experimentalForceLongPolling: true });

    const USER_KEY = 'attendanceUsername';
    let myName = localStorage.getItem(USER_KEY) || '';
    let hasCheckin = false;

    const nameField = document.getElementById('nameField');
    const statusEl = document.getElementById('status');
    const checkinBtn = document.getElementById('checkinBtn');
    const chatSection = document.getElementById('chatSection');

    // HI·ªÇN TH·ªä T√äN NGAY L·∫¨P T·ª®C N·∫æU C√ì
    if (myName) {
      nameField.value = myName;
      statusEl.textContent = "üîî S·∫µn s√†ng ƒëi·ªÉm danh cho " + myName;
    }

    // LISTENER D·ªÆ LI·ªÜU NG∆Ø·ªúI D√ôNG
    db.collection('users').onSnapshot(snap => {
      const list = [];
      const today = new Date().toISOString().split('T')[0];
      snap.forEach(d => {
        const data = d.data();
        list.push({ name: d.id, count: (data.checkins || []).length });
        if (d.id === myName) {
          hasCheckin = (data.checkins || []).includes(today);
        }
      });
      list.sort((a, b) => b.count - a.count);
      renderLeaderboard(list);
      updateUI();
    }, err => {
      statusEl.innerHTML = "<span style='color:var(--danger)'>‚ùå L·ªói: " + err.message + "</span>";
    });

    // LISTENER CHAT
    db.collection('messages').orderBy('time', 'desc').limit(40).onSnapshot(snap => {
      const msgs = [];
      snap.forEach(d => msgs.push(d.data()));
      renderChat(msgs.reverse());
    });

    function renderLeaderboard(list) {
      const body = document.getElementById('leaderBody');
      if (list.length === 0) {
        body.innerHTML = '<tr><td colspan="3" style="text-align:center; opacity:0.5;">Ch∆∞a c√≥ ai ƒëi·ªÉm danh.</td></tr>';
        return;
      }
      body.innerHTML = list.map((u, i) => `
        <tr class="${u.name === myName ? 'me' : ''}">
          <td>${i + 1}</td><td>${u.name}</td><td>${u.count}</td>
        </tr>
      `).join('');
    }

    function renderChat(msgs) {
      const box = document.getElementById('chatBox');
      box.innerHTML = msgs.map(m => `
        <div class="msg">
          <span class="msg-user">${m.user}:</span><span class="msg-text">${m.text}</span>
        </div>
      `).join('');
      box.scrollTop = box.scrollHeight;
    }

    function updateUI() {
      if (!myName) {
        checkinBtn.disabled = true;
        chatSection.style.display = "none";
        return;
      }

      if (hasCheckin) {
        statusEl.innerHTML = "<span style='color:var(--success)'>‚úÖ B·∫°n ƒë√£ ƒëi·ªÉm danh th√†nh c√¥ng h√¥m nay!</span>";
        checkinBtn.disabled = true;
        checkinBtn.textContent = "H·∫∏N G·∫∂P L·∫†I V√ÄO MAI CH√öC B·∫†N MAY M·∫ÆN";
        chatSection.style.display = "block";
      } else {
        statusEl.innerHTML = "üîî " + myName + " ∆°i, ƒëi·ªÉm danh th√¥i!";
        checkinBtn.disabled = false;
        checkinBtn.textContent = "üü¢ ƒêI·ªÇM DANH NGAY";
        chatSection.style.display = "none";
      }
    }

    // L∆ØU T√äN
    document.getElementById('saveBtn').onclick = async () => {
      const n = nameField.value.trim();
      if (!n) return;

      const oldName = myName;
      myName = n;
      localStorage.setItem(USER_KEY, n);

      statusEl.textContent = "‚è≥ ƒêang ghi t√™n l√™n h·ªá th·ªëng...";
      try {
        // T·∫°o user tr√™n server ƒë·ªÉ BXH hi·ªán ra ngay
        await db.collection('users').doc(n).set({ checkins: [] }, { merge: true });
        location.reload(); // Reload ƒë·ªÉ ƒë·ªìng b·ªô l·∫°i to√†n b·ªô
      } catch (e) {
        alert("L·ªói l∆∞u t√™n: " + e.message);
        myName = oldName;
      }
    };

    // ƒêI·ªÇM DANH
    checkinBtn.onclick = async () => {
      if (!myName || checkinBtn.disabled) return;

      checkinBtn.disabled = true;
      checkinBtn.textContent = "‚è≥ ƒêang ghi d·ªØ li·ªáu...";

      try {
        const today = new Date().toISOString().split('T')[0];
        const ref = db.collection('users').doc(myName);
        const snap = await ref.get();
        const data = snap.data() || { checkins: [] };

        if (!data.checkins.includes(today)) {
          data.checkins.push(today);
          await ref.set({ checkins: data.checkins }, { merge: true });
          // onSnapshot s·∫Ω t·ª± c·∫≠p nh·∫≠t UI
        }
      } catch (e) {
        alert("L·ªói ƒëi·ªÉm danh: " + e.message);
        checkinBtn.disabled = false;
        checkinBtn.textContent = "üü¢ TH·ª¨ L·∫†I NGAY";
      }
    };

    // G·ª¨I CHAT
    async function sendChat() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text || !myName || !hasCheckin) return;
      input.value = "";
      try {
        await db.collection('messages').add({
          user: myName,
          text: text,
          time: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (e) { console.error(e); }
    }

    document.getElementById('sendBtn').onclick = sendChat;
    document.getElementById('chatInput').onkeypress = (e) => { if (e.key === 'Enter') sendChat(); };

    // ƒê·ªíNG H·ªí
    setInterval(() => {
      const diff = new Date().setHours(24, 0, 0, 0) - new Date();
      const h = Math.floor(diff / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
      document.getElementById('countdown').textContent = `‚è≥ H·∫øt h·∫°n: ${h}h ${m}m ${s}s`;
    }, 1000);
  </script>
</body>

</html>