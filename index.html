<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Äiá»ƒm danh v3.9 - SIÃŠU Káº¾T Ná»I</title>
  <style>
    :root {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --primary: #38bdf8;
      --danger: #f87171;
      --success: #4ade80;
      --text: #e2e8f0;
      --radius: 12px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 15px;
    }

    .container {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
      text-align: center;
      max-width: 450px;
      width: 100%;
    }

    h1 {
      color: var(--primary);
      margin: 0.5rem 0;
      font-size: 1.8rem;
    }

    .ver {
      font-size: 0.75rem;
      color: var(--success);
      font-weight: bold;
      margin-bottom: 1.5rem;
      display: block;
    }

    .countdown {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #fde047;
    }

    .input-group {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 1rem;
    }

    input {
      padding: 0.85rem;
      border-radius: 10px;
      border: 2px solid #334155;
      background: #0f172a;
      color: #fff;
      width: 100%;
      outline: none;
    }

    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.8rem 1.4rem;
      font-size: 1rem;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s;
      font-weight: bold;
    }

    .btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .status {
      margin: 1rem 0;
      font-size: 1rem;
      padding: 15px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
    }

    .leaderboard {
      margin-top: 2rem;
      text-align: left;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    td {
      padding: 12px 10px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
    }

    tr.me {
      background: rgba(56, 189, 248, 0.15);
      border-left: 4px solid var(--primary);
    }

    .chat-section {
      margin-top: 2.5rem;
      border-top: 2px solid #334155;
      padding-top: 1.5rem;
      display: none;
    }

    .chat-box {
      background: #0b1120;
      border-radius: 12px;
      height: 180px;
      overflow-y: auto;
      padding: 15px;
      margin-bottom: 12px;
      text-align: left;
      border: 1px solid #334155;
    }

    .msg {
      margin-bottom: 8px;
      font-size: 0.85rem;
    }

    .msg-user {
      font-weight: bold;
      color: var(--primary);
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ“… Äiá»ƒm danh v3.9</h1>
    <span class="ver">âœ… SIÃŠU Káº¾T Ná»I (KHÃ”NG Cáº¦N CHá»œ Máº NG)</span>

    <div id="countdown" class="countdown">â³ ...</div>

    <div class="input-group">
      <input type="text" id="nameField" placeholder="TÃªn cá»§a báº¡n..." />
      <button id="saveBtn" class="btn">LÆ°u</button>
    </div>

    <div id="status" class="status">Äang táº£i dá»¯ liá»‡u...</div>
    <button id="checkinBtn" class="btn" style="width: 100%; height: 55px;" disabled>ğŸŸ¢ ÄIá»‚M DANH NGAY</button>

    <div class="leaderboard">
      <h3>ğŸ† Báº£ng xáº¿p háº¡ng</h3>
      <table>
        <tbody id="leaderBody"></tbody>
      </table>
    </div>

    <div id="chatSection" class="chat-section">
      <div style="text-align:left; color: var(--primary); font-weight:bold; margin-bottom:10px;">ğŸ’¬ Chat</div>
      <div id="chatBox" class="chat-box"></div>
      <div class="input-group">
        <input type="text" id="chatInput" placeholder="Nháº¯n tin..." />
        <button id="sendBtn" class="btn">Gá»­i</button>
      </div>
    </div>
    <button onclick="localStorage.clear(); location.reload();"
      style="margin-top:20px; background:none; border:none; color:var(--danger); cursor:pointer; font-size:0.7rem;">XÃ“A
      TÃŠN & RESET</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const config = {
      apiKey: "AIzaSyDhgpbLOVXdQ5Q6UvkYYMPi66RFdZ4ogLc",
      authDomain: "dielife-d5a74.firebaseapp.com",
      projectId: "dielife-d5a74",
      storageBucket: "dielife-d5a74.firebasestorage.app",
      messagingSenderId: "654557385964",
      appId: "1:654557385964:web:22f4debf14df0ae26e81c9"
    };
    firebase.initializeApp(config);
    const db = firebase.firestore();

    // Cáº¥u hÃ¬nh SIÃŠU Káº¾T Ná»I (v3.9)
    db.settings({
      experimentalForceLongPolling: true,
      useFetchStreams: false
    });

    const USER_KEY = 'attendanceUsername';
    let myName = localStorage.getItem(USER_KEY) || '';
    let hasCheckin = false;

    // Listeners (Má»i thá»© cháº¡y Real-time)
    db.collection('users').onSnapshot(snap => {
      const list = [];
      const today = new Date().toISOString().split('T')[0];
      snap.forEach(d => {
        const data = d.data() || { checkins: [] };
        list.push({ name: d.id, count: (data.checkins || []).length });
        if (d.id === myName) {
          hasCheckin = (data.checkins || []).includes(today);
        }
      });
      list.sort((a, b) => b.count - a.count);
      document.getElementById('leaderBody').innerHTML = list.map((u, i) => `
        <tr class="${u.name === myName ? 'me' : ''}"><td>${i + 1}</td><td>${u.name}</td><td>${u.count}</td></tr>
      `).join('');
      updateUI();
    }, err => {
      console.log("âŒ Lá»—i Firebase:", err.message);
      document.getElementById('status').innerHTML = "<span style='color:var(--danger)'>Máº¡ng yáº¿u, Ä‘ang thá»­ láº¡i...</span>";
    });

    db.collection('messages').orderBy('time', 'desc').limit(30).onSnapshot(snap => {
      const msgs = [];
      snap.forEach(d => msgs.push(d.data()));
      document.getElementById('chatBox').innerHTML = msgs.map(m => `
        <div class="msg"><span class="msg-user">${m.user}:</span><span> ${m.text}</span></div>
      `).join('');
    });

    function updateUI() {
      const field = document.getElementById('nameField');
      if (myName) field.value = myName;

      const btn = document.getElementById('checkinBtn');
      const st = document.getElementById('status');
      const chat = document.getElementById('chatSection');

      if (!myName) {
        st.textContent = "ğŸ‘‹ Vui lÃ²ng nháº­p tÃªn.";
        btn.disabled = true;
        chat.style.display = "none";
      } else if (hasCheckin) {
        st.innerHTML = "<span style='color:var(--success)'>âœ… ÄÃ£ Ä‘iá»ƒm danh thÃ nh cÃ´ng!</span>";
        btn.disabled = true; btn.textContent = "NHáº¬N DIá»†N THÃ€NH CÃ”NG";
        chat.style.display = "block";
      } else {
        st.innerHTML = "ğŸ”” ÄÃ£ sáºµn sÃ ng cho: <b>" + myName + "</b>";
        btn.disabled = false; btn.textContent = "ğŸŸ¢ ÄIá»‚M DANH NGAY";
        chat.style.display = "none";
      }
    }

    // LÆ¯U TÃŠN (KHÃ”NG CHá»œ PHáº¢N Há»’I Máº NG - OPTIMISTIC - v3.9)
    document.getElementById('saveBtn').onclick = () => {
      const n = document.getElementById('nameField').value.trim();
      if (!n) return;
      myName = n;
      localStorage.setItem(USER_KEY, n);

      // Gá»­i lá»‡nh set nhÆ°ng khÃ´ng dÃ¹ng 'await' Ä‘á»ƒ khÃ´ng bá»‹ káº¹t náº¿u máº¡ng yáº¿u
      db.collection('users').doc(n).set({}, { merge: true });
      updateUI();
      log("ğŸ’¾ ÄÃ£ ghi nhá»› tÃªn: " + n);
    };

    // ÄIá»‚M DANH (DÃ™NG arrayUnion - KHÃ”NG Cáº¦N Äá»ŒC Dá»® LIá»†U - v3.9)
    document.getElementById('checkinBtn').onclick = () => {
      if (!myName) return;
      const btn = document.getElementById('checkinBtn');
      btn.disabled = true; btn.textContent = "â³ ÄANG Gá»¬I...";

      const today = new Date().toISOString().split('T')[0];
      // arrayUnion cho phÃ©p ghi dá»¯ liá»‡u mÃ  khÃ´ng cáº§n Ä‘á»c (get) trÆ°á»›c, giÃºp trÃ¡nh lá»—i offline
      db.collection('users').doc(myName).update({
        checkins: firebase.firestore.FieldValue.arrayUnion(today)
      }).then(() => {
        log("âœ… Gá»­i thÃ nh cÃ´ng!");
      }).catch(e => {
        console.log("âš ï¸ Gá»­i cháº­m, Ä‘ang chá» máº¡ng...", e.message);
        // Ngay cáº£ khi lá»—i, Firestore sáº½ tá»± Ä‘á»™ng gá»­i láº¡i khi cÃ³ máº¡ng
      });
    };

    async function sendChat() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text || !myName || !hasCheckin) return;
      input.value = "";
      db.collection('messages').add({
        user: myName, text, time: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    document.getElementById('sendBtn').onclick = sendChat;
    document.getElementById('chatInput').onkeypress = (e) => { if (e.key === 'Enter') sendChat(); };

    setInterval(() => {
      const diff = new Date().setHours(24, 0, 0, 0) - new Date();
      if (diff < 0) location.reload();
      const h = Math.floor(diff / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
      document.getElementById('countdown').textContent = `â³ Háº¿t háº¡n: ${h}h ${m}m ${s}s`;
    }, 1000);

    function log(m) { console.log(m); }
    updateUI();
  </script>
</body>

</html>