<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Äiá»ƒm danh v4.0 - Báº¢N Tá»I THÆ¯á»¢NG</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f1a;
      --card-bg: #161c2d;
      --primary: #38bdf8;
      --danger: #ef4444;
      --success: #22c55e;
      --text: #f1f5f9;
      --radius: 12px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 15px;
    }

    .container {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
      text-align: center;
      max-width: 450px;
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    h1 {
      color: var(--primary);
      margin: 0;
      font-size: 1.8rem;
      letter-spacing: -1px;
    }

    .ver {
      font-size: 0.75rem;
      color: var(--success);
      font-weight: bold;
      margin-bottom: 20px;
      display: block;
    }

    .countdown {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 20px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      color: #fde047;
      border: 1px solid rgba(253, 224, 71, 0.2);
    }

    .input-group {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 1rem;
    }

    input {
      padding: 1rem;
      border-radius: 10px;
      border: 2px solid #334155;
      background: #0f172a;
      color: #fff;
      width: 100%;
      outline: none;
      transition: 0.2s;
    }

    input:focus {
      border-color: var(--primary);
    }

    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.2s;
      font-weight: bold;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .status {
      margin: 15px 0;
      font-size: 1rem;
      height: 1.5rem;
    }

    .leaderboard {
      margin-top: 25px;
      text-align: left;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      opacity: 0.4;
      font-size: 0.7rem;
      text-transform: uppercase;
      padding-bottom: 10px;
    }

    td {
      padding: 12px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    tr.me {
      border-left: 4px solid var(--primary);
      background: rgba(56, 189, 248, 0.1);
    }

    .chat-section {
      margin-top: 30px;
      border-top: 2px solid #334155;
      padding-top: 20px;
      display: none;
    }

    .chat-box {
      background: #0b1120;
      border-radius: 12px;
      height: 180px;
      overflow-y: auto;
      padding: 15px;
      margin-bottom: 12px;
      text-align: left;
      border: 1px solid #334155;
      display: flex;
      flex-direction: column-reverse;
    }

    .msg {
      margin-bottom: 8px;
      font-size: 0.85rem;
    }

    .msg-u {
      font-weight: bold;
      color: var(--primary);
    }

    .net-label {
      font-size: 0.65rem;
      opacity: 0.5;
      margin-top: 20px;
      display: block;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ“… Äiá»ƒm danh v4.0</h1>
    <span class="ver">â­ PHIÃŠN Báº¢N CHá»NG Máº¤T Dá»® LIá»†U & Lá»–I Máº NG â­</span>

    <div id="countdown" class="countdown">â³ Äang khá»Ÿi Ä‘á»™ng...</div>

    <div class="input-group">
      <input type="text" id="nameField" placeholder="Nháº­p tÃªn cá»§a báº¡n..." />
      <button id="saveBtn" class="btn">LÆ°u</button>
    </div>

    <div id="status" class="status">Äang kiá»ƒm tra káº¿t ná»‘i...</div>
    <button id="checkinBtn" class="btn" style="width: 100%;" disabled>ğŸŸ¢ ÄIá»‚M DANH NGAY</button>

    <div class="leaderboard">
      <h3 style="margin-bottom:10px;">ğŸ† BXH (Real-time)</h3>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>TÃªn</th>
            <th>NgÃ y</th>
          </tr>
        </thead>
        <tbody id="leaderBody"></tbody>
      </table>
    </div>

    <div id="chatSection" class="chat-section">
      <div style="text-align:left; color: var(--primary); font-weight:bold; margin-bottom:10px;">ğŸ’¬ Group Chat</div>
      <div id="chatBox" class="chat-box"></div>
      <div class="input-group">
        <input type="text" id="chatInput" placeholder="Nháº¯n tin..." />
        <button id="sendBtn" class="btn">Gá»­i</button>
      </div>
    </div>

    <span class="net-label" id="netLabel">ğŸ“¡ TrÃ¬nh tráº¡ng: Äang káº¿t ná»‘i server...</span>

    <div style="margin-top: 15px;">
      <button onclick="if(confirm('XÃ³a sáº¡ch bá»™ nhá»›?')){localStorage.clear(); location.reload();}"
        style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:0.7rem;">ğŸ—‘ï¸ Reset dá»¯ liá»‡u
        cá»¥c bá»™</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDhgpbLOVXdQ5Q6UvkYYMPi66RFdZ4ogLc",
      authDomain: "dielife-d5a74.firebaseapp.com",
      projectId: "dielife-d5a74",
      storageBucket: "dielife-d5a74.firebasestorage.app",
      messagingSenderId: "654557385964",
      appId: "1:654557385964:web:22f4debf14df0ae26e81c9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 1. Cáº¥u hÃ¬nh chá»‘ng máº¥t dá»¯ liá»‡u VÃ€ lá»—i máº¡ng
    db.settings({ experimentalForceLongPolling: true, useFetchStreams: false });

    // 2. KÃ­ch hoáº¡t lÆ°u trá»¯ vÃ o á»• cá»©ng (Survival Mode)
    // GiÃºp dá»¯ liá»‡u khÃ´ng máº¥t khi F5 ngay cáº£ khi offline
    firebase.firestore().enablePersistence({ synchronizeTabs: true })
      .then(() => console.log("âœ… ÄÃ£ báº­t lÆ°u trá»¯ Disk Persistence"))
      .catch((e) => console.log("âš ï¸ KhÃ´ng thá»ƒ báº­t Persistence:", e.code));

    const USER_KEY = 'attendanceUsername';
    let myName = localStorage.getItem(USER_KEY) || '';
    let hasCheckin = false;
    let isConnected = false;

    const nameField = document.getElementById('nameField');
    const statusEl = document.getElementById('status');
    const checkinBtn = document.getElementById('checkinBtn');
    const chatSection = document.getElementById('chatSection');
    const netLabel = document.getElementById('netLabel');

    if (myName) nameField.value = myName;

    // THEO DÃ•I TRáº NG THÃI Káº¾T Ná»I
    db.doc(".info/connected").onSnapshot(() => { }); // Chá»‰ Ä‘á»ƒ giá»¯ session

    // DÃ¹ng onSnapshot lÃ m Ä‘á»™ng lá»±c duy nháº¥t
    db.collection('users').onSnapshot(snap => {
      isConnected = true;
      netLabel.innerHTML = "ğŸ“¡ Tráº¡ng thÃ¡i: <span style='color:#22c55e'>ÄÃ£ káº¿t ná»‘i trá»±c tiáº¿p</span>";

      const list = [];
      const today = new Date().toISOString().split('T')[0];

      snap.forEach(d => {
        const data = d.data();
        list.push({ n: d.id, c: (data.checkins || []).length });
        if (d.id === myName) {
          hasCheckin = (data.checkins || []).includes(today);
        }
      });

      list.sort((a, b) => b.c - a.c);
      document.getElementById('leaderBody').innerHTML = list.map((u, i) => `
        <tr class="${u.n === myName ? 'me' : ''}"><td>${i + 1}</td><td>${u.n}</td><td>${u.c}</td></tr>
      `).join('');
      updateUI();
    }, err => {
      console.log("Firestore Offline:", err.message);
      netLabel.innerHTML = "ğŸ“¡ Tráº¡ng thÃ¡i: <span style='color:#fde047'>Äang cháº¡y ngoáº¡i tuyáº¿n (Sáº½ Ä‘á»“ng bá»™ sau)</span>";
      updateUI();
    });

    db.collection('messages').orderBy('time', 'desc').limit(25).onSnapshot(snap => {
      const msgs = [];
      snap.forEach(d => msgs.push(d.data()));
      document.getElementById('chatBox').innerHTML = msgs.map(m => `
        <div class="msg"><span class="msg-u">${m.user}:</span><span> ${m.text}</span></div>
      `).join('');
    });

    function updateUI() {
      if (!myName) {
        statusEl.textContent = "ğŸ‘‹ Vui lÃ²ng nháº­p tÃªn cá»§a báº¡n.";
        checkinBtn.disabled = true;
        chatSection.style.display = "none";
      } else if (hasCheckin) {
        statusEl.innerHTML = "<span style='color:var(--success)'>âœ… Báº¡n Ä‘Ã£ Ä‘iá»ƒm danh hÃ´m nay!</span>";
        checkinBtn.disabled = true;
        checkinBtn.textContent = "Háº¸N Gáº¶P Láº I VÃ€O MAI";
        chatSection.style.display = "block";
      } else {
        statusEl.innerHTML = "ğŸ”” Sáºµn sÃ ng: <b>" + myName + "</b>";
        checkinBtn.disabled = false;
        checkinBtn.textContent = "ğŸŸ¢ ÄIá»‚M DANH NGAY";
        chatSection.style.display = "none";
      }
    }

    // LÆ¯U TÃŠN (KHÃ”NG CHá»œ SERVER - v4.0)
    document.getElementById('saveBtn').onclick = () => {
      const n = nameField.value.trim();
      if (!n) return;
      myName = n;
      localStorage.setItem(USER_KEY, n);

      // Ghi Ã¢m tháº§m, persistence sáº½ lo pháº§n cÃ²n láº¡i
      db.collection('users').doc(n).set({}, { merge: true });
      updateUI();
    };

    // ÄIá»‚M DANH Tá»I THÆ¯á»¢NG (v4.0)
    checkinBtn.onclick = () => {
      if (!myName) return;
      const t = new Date().toISOString().split('T')[0];

      // set + arrayUnion lÃ  cÃ¡ch ghi an toÃ n nháº¥t khi offline
      db.collection('users').doc(myName).set({
        checkins: firebase.firestore.FieldValue.arrayUnion(t)
      }, { merge: true }).then(() => {
        console.log("âœ… Ghi thÃ nh cÃ´ng");
      }).catch(e => {
        console.log("â³ ÄÃ£ lÆ°u cá»¥c bá»™, sáº½ Ä‘á»“ng bá»™ khi cÃ³ máº¡ng.");
      });

      // Fake UI ngay láº­p tá»©c
      hasCheckin = true;
      updateUI();
    };

    async function sendChat() {
      const i = document.getElementById('chatInput');
      const text = i.value.trim();
      if (!text || !myName || !hasCheckin) return;
      i.value = "";
      db.collection('messages').add({
        user: myName, text, time: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    document.getElementById('sendBtn').onclick = sendChat;
    document.getElementById('chatInput').onkeypress = (e) => { if (e.key === 'Enter') sendChat(); };

    setInterval(() => {
      const diff = new Date().setHours(24, 0, 0, 0) - new Date();
      if (diff < 0) location.reload();
      const h = Math.floor(diff / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
      document.getElementById('countdown').textContent = `â³ Háº¿t háº¡n: ${h}h ${m}m ${s}s`;
    }, 1000);
  </script>
</body>

</html>